openapi: 3.0.3
info:
  title: Physical AI Textbook RAG Chatbot API
  description: |
    RESTful API for the Physical AI & Humanoid Robotics textbook RAG chatbot.
    Provides endpoints for chat queries, authentication, personalization, and translation.
  version: 1.0.0
  contact:
    name: Panaversity Hackathon Team

servers:
  - url: http://localhost:8000/api/v1
    description: Development server
  - url: https://textbook-backend.railway.app/api/v1
    description: Production server

tags:
  - name: Health
    description: Health check endpoints
  - name: Chat
    description: RAG chatbot endpoints (Base 100 points)
  - name: Auth
    description: Authentication endpoints (Bonus 50 points)
  - name: Personalization
    description: Content personalization endpoints (Bonus 50 points)
  - name: Translation
    description: Urdu translation endpoints (Bonus 50 points)

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns API health status
      operationId: getHealth
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /chat:
    post:
      tags:
        - Chat
      summary: Send chat message
      description: |
        Send a message to the RAG chatbot and receive an AI-generated response
        with citations to relevant textbook sections.
      operationId: sendChatMessage
      security:
        - BearerAuth: []
        - {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /chat/sessions/{session_id}:
    get:
      tags:
        - Chat
      summary: Get chat session history
      description: Retrieve the message history for a chat session
      operationId: getChatSession
      security:
        - BearerAuth: []
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Chat session history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatSessionResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags:
        - Chat
      summary: Delete chat session
      description: Clear chat history for a session
      operationId: deleteChatSession
      security:
        - BearerAuth: []
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Session deleted successfully
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/signup:
    post:
      tags:
        - Auth
      summary: User signup
      description: Register a new user with background information
      operationId: signup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/signin:
    post:
      tags:
        - Auth
      summary: User signin
      description: Authenticate user and receive JWT token
      operationId: signin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SigninRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/profile:
    get:
      tags:
        - Auth
      summary: Get user profile
      description: Get current user profile with personalization settings
      operationId: getProfile
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /personalize/chapter:
    post:
      tags:
        - Personalization
      summary: Personalize chapter content
      description: |
        Generate personalized chapter content based on user's background.
        Returns cached version if available.
      operationId: personalizeChapter
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PersonalizeRequest'
      responses:
        '200':
          description: Personalized content
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PersonalizeResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Chapter not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /personalize/status/{chapter_id}:
    get:
      tags:
        - Personalization
      summary: Get personalization status
      description: Check if personalized content exists for a chapter
      operationId: getPersonalizationStatus
      security:
        - BearerAuth: []
      parameters:
        - name: chapter_id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
            maximum: 24
      responses:
        '200':
          description: Personalization status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PersonalizationStatusResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /translate/chapter:
    post:
      tags:
        - Translation
      summary: Translate chapter to Urdu
      description: |
        Generate Urdu translation of chapter content.
        Technical terms (ROS 2, URDF, etc.) are preserved in English.
        Returns cached version if available.
      operationId: translateChapter
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TranslateRequest'
      responses:
        '200':
          description: Translated content
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TranslateResponse'
        '404':
          description: Chapter not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /translate/chapters:
    get:
      tags:
        - Translation
      summary: List available translations
      description: Get list of chapters with available translations
      operationId: listTranslations
      responses:
        '200':
          description: Available translations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TranslationListResponse'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    HealthResponse:
      type: object
      required:
        - status
        - service
      properties:
        status:
          type: string
          example: ok
        service:
          type: string
          example: textbook-rag-api
        version:
          type: string
          example: 1.0.0

    ChatRequest:
      type: object
      required:
        - message
      properties:
        session_id:
          type: string
          format: uuid
          description: Existing session ID to continue conversation
        message:
          type: string
          maxLength: 2000
          example: What is ROS 2 and how does it differ from ROS 1?
        selected_text:
          type: string
          maxLength: 1000
          description: User-selected text from the page for context
        context_chapter_id:
          type: integer
          minimum: 1
          maximum: 24
          description: Current chapter ID for context-aware responses

    ChatResponse:
      type: object
      required:
        - session_id
        - response
        - sources
      properties:
        session_id:
          type: string
          format: uuid
        response:
          type: string
          description: AI-generated response
        sources:
          type: array
          items:
            $ref: '#/components/schemas/Source'

    Source:
      type: object
      required:
        - chapter_id
        - section_title
        - snippet
      properties:
        chapter_id:
          type: integer
          example: 2
        section_title:
          type: string
          example: "Why ROS 2? (vs. ROS 1)"
        snippet:
          type: string
          maxLength: 200
          description: Relevant text excerpt

    ChatSessionResponse:
      type: object
      required:
        - session_id
        - messages
        - created_at
      properties:
        session_id:
          type: string
          format: uuid
        messages:
          type: array
          items:
            $ref: '#/components/schemas/ChatMessage'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ChatMessage:
      type: object
      required:
        - role
        - content
        - timestamp
      properties:
        role:
          type: string
          enum: [user, assistant]
        content:
          type: string
        timestamp:
          type: string
          format: date-time
        context_chapter_id:
          type: integer
        selected_text:
          type: string
        sources:
          type: array
          items:
            $ref: '#/components/schemas/Source'

    SignupRequest:
      type: object
      required:
        - email
        - password
        - name
        - software_background
        - hardware_background
      properties:
        email:
          type: string
          format: email
          example: student@example.com
        password:
          type: string
          minLength: 8
          example: securepassword123
        name:
          type: string
          minLength: 2
          maxLength: 100
          example: Ali Khan
        software_background:
          type: string
          enum: [beginner, intermediate, advanced]
        hardware_background:
          type: string
          enum: [none, hobbyist, professional]

    SigninRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    AuthResponse:
      type: object
      required:
        - access_token
        - user
      properties:
        access_token:
          type: string
          description: JWT access token
        user:
          $ref: '#/components/schemas/UserSummary'

    UserSummary:
      type: object
      required:
        - id
        - email
        - name
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string

    UserProfileResponse:
      type: object
      required:
        - user
        - personalization
      properties:
        user:
          $ref: '#/components/schemas/UserSummary'
        personalization:
          $ref: '#/components/schemas/PersonalizationProfile'

    PersonalizationProfile:
      type: object
      required:
        - software_background
        - hardware_background
      properties:
        software_background:
          type: string
          enum: [beginner, intermediate, advanced]
        hardware_background:
          type: string
          enum: [none, hobbyist, professional]
        learning_goals:
          type: array
          items:
            type: string
        preferred_complexity:
          type: string
          enum: [simplified, standard, detailed]
          default: standard

    PersonalizeRequest:
      type: object
      required:
        - chapter_id
      properties:
        chapter_id:
          type: integer
          minimum: 1
          maximum: 24

    PersonalizeResponse:
      type: object
      required:
        - chapter_id
        - personalized_content
        - cached
      properties:
        chapter_id:
          type: integer
        personalized_content:
          type: string
          description: Personalized markdown content
        cached:
          type: boolean
          description: Whether this was served from cache

    PersonalizationStatusResponse:
      type: object
      required:
        - available
      properties:
        available:
          type: boolean
        last_generated:
          type: string
          format: date-time

    TranslateRequest:
      type: object
      required:
        - chapter_id
      properties:
        chapter_id:
          type: integer
          minimum: 1
          maximum: 24
        target_language:
          type: string
          default: ur
          enum: [ur]

    TranslateResponse:
      type: object
      required:
        - chapter_id
        - translated_content
        - language
        - cached
      properties:
        chapter_id:
          type: integer
        translated_content:
          type: string
          description: Translated markdown content
        language:
          type: string
          example: ur
        cached:
          type: boolean

    TranslationListResponse:
      type: object
      required:
        - translations
      properties:
        translations:
          type: array
          items:
            type: object
            properties:
              chapter_id:
                type: integer
              languages:
                type: array
                items:
                  type: string

    ErrorResponse:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          description: Error message
        code:
          type: string
          description: Error code for client handling
